docker exec -u postgres -e PGPASSWORD=password123 edapp-postgres-1 psql -U edapp -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"; CREATE EXTENSION IF NOT EXISTS pgcrypto; CREATE SCHEMA IF NOT EXISTS auth; CREATE TABLE IF NOT EXISTS auth.users (id uuid PRIMARY KEY DEFAULT uuid_generate_v4(), email text UNIQUE, encrypted_password text, created_at timestamptz DEFAULT now()); DO \$\$ BEGIN CREATE TYPE public.app_role AS ENUM ('admin', 'staff', 'parent', 'student'); EXCEPTION WHEN duplicate_object THEN null; END \$\$; CREATE TABLE IF NOT EXISTS public.profiles (id uuid PRIMARY KEY, email text NOT NULL, first_name text, last_name text, role app_role DEFAULT 'parent'::app_role, tenant_id uuid REFERENCES public.tenants(id) ON DELETE SET NULL, created_at timestamptz DEFAULT now() NOT NULL, password_hash text); DO \$\$ DECLARE v_tenant_id uuid; v_user_id uuid; v_hash text := crypt('password123', gen_salt('bf')); BEGIN SELECT id INTO v_tenant_id FROM tenants WHERE domain = 'lakewood.edapp.co.za'; INSERT INTO auth.users (email) VALUES ('admin@lakewood.edu') ON CONFLICT (email) DO NOTHING; SELECT id INTO v_user_id FROM auth.users WHERE email = 'admin@lakewood.edu'; INSERT INTO profiles (id, email, first_name, last_name, role, tenant_id, password_hash) VALUES (v_user_id, 'admin@lakewood.edu', 'Admin', 'User', 'staff', v_tenant_id, v_hash) ON CONFLICT (id) DO UPDATE SET role = 'staff', password_hash = v_hash, tenant_id = v_tenant_id; END \$\$;"
